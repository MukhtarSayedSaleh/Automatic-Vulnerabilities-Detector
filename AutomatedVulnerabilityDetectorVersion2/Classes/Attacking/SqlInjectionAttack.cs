/*
 * SQL Injection Attack Class
 * the main purpose of this class is to scan
 * a webpage against the SQL Injection vulnerabilities
 * 
 *       Mukhtar Sayed Saleh
 *       Syria- Al_Boukamal
 *       mokhtar_ss@hotmail.com
 *       00963944467547   
 *       
 *   start date : 30-9-2010
 *   finish date : 15-10-2010
 *   testing start date : 2-10-2010
 *   testing finish date : 16-10-2010 // OK
 */

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Net;
using System.IO;
using AutomatedVulnerabilityDetectorVersion2.Classes.Web;
using AutomatedVulnerabilityDetectorVersion2.Classes.DB;
using AutomatedVulnerabilityDetectorVersion2.GUIs;

namespace AutomatedVulnerabilityDetectorVersion2.Classes.Attacking
{
    class SqlInjectionAttack
    {
        //profile id
        int _profileID;

        //list of query strings of url;
        protected List<string> queryStrings;

        //first element from each list is an ABSOULUTE URL of the form "action" attribute.
        // all other elements are field names.
        protected List<List<string>> inputFields;

        //the attack pattern , TODO : ADD MORE PATTERNS!!!!
        protected string sqlAttackPattern = "1' OR 1 OR 1='"; // just to generate sql parsing error!

        // the static parts of all error messages of the famous (DBMS)es
        protected string[] sqlSuccessResult = { "valid MySQL", "SQL syntax", "ODBC Microsoft Access Driver", "java.sql.SQLException", "XPathException", "valid ldap", "javax.naming.NameNotFoundException", "System.FormatException", "System.Data.SqlClient.SqlException" };

        /// <summary>
        ///  Default constructor of the class
        /// </summary>
        public SqlInjectionAttack(int profileID)
        {
            this._profileID = profileID;
            this.queryStrings = new List<string>();
            this.inputFields = new List<List<string>>();
        }


        /// <summary>
        ///  attack all input fields with sql injection pattern.
        /// </summary>
        public void attackAllInputfields(string URL)
        {
            // get page content
            WebCrawler spider = new WebCrawler(URL);
            string htmlContent = spider.fetchPage();
            HtmlParser parser = new HtmlParser(URL, htmlContent);
            // fetch forms input fields
            List<List<string>> inputFields = parser.getFormsInputFields();
            //for each form
            for (int currentFormID = 0; currentFormID < inputFields.Count; currentFormID++)
            {
                string currentFormURL = inputFields[currentFormID][0];
                string currentFormFieldsHeader = string.Empty;
                // for each input field
                for (int currentInputFieldID = 1; currentInputFieldID < inputFields[currentFormID].Count; currentInputFieldID++)
                {
                    //sql injection the current input field only
                    if (currentFormFieldsHeader != string.Empty) // second param
                    {
                        currentFormFieldsHeader += "&" + inputFields[currentFormID][currentInputFieldID] + "=" + sqlAttackPattern;
                    }
                    else // first param
                    {
                        currentFormFieldsHeader += inputFields[currentFormID][currentInputFieldID] + "=" + sqlAttackPattern;
                    }
                }

                //just for tests
                //System.Windows.Forms.MessageBox.Show(currentFormFieldsHeader);

                // send the post request here
                WebPostRequest myPost = new WebPostRequest(currentFormURL);
                myPost.AddParamsToHeader(currentFormFieldsHeader);
                string resultHTML = myPost.GetResponse();

                //check the returned page
                foreach (string s in sqlSuccessResult)
                {
                    if (resultHTML.Contains(s))
                    {
                        // it is a vulnerable page !
                        SharedVariables.myTestingForm.displayOutputActivity("the page : " + currentFormURL + " has a SQL Injection vulnerable in one of its form fields\n\r saving the vulnerability for later reviews");
                        ExploitsManager e = new ExploitsManager();
                        e.add(_profileID.ToString(), "SQL Injection", currentFormURL + " \n\r form fields values : " + currentFormFieldsHeader, "Unknown");
                    }
                }
            }
        }

        /// <summary>
        ///  attack each input field with sql injection pattern to know exactly where is the exploit.
        /// </summary>
        public void attackEachInputfield(string URL)
        {
            // get page content
            WebCrawler spider = new WebCrawler(URL);
            string htmlContent = spider.fetchPage();
            HtmlParser parser = new HtmlParser(URL, htmlContent);
            // fetch forms input fields
            List<List<string>> inputFields = parser.getFormsInputFields();
            //for each form
            for (int currentFormID = 0; currentFormID < inputFields.Count; currentFormID++)
            {
                string currentFormURL = inputFields[currentFormID][0];
                // for each input field
                for (int currentInputFieldID = 1; currentInputFieldID < inputFields[currentFormID].Count; currentInputFieldID++)
                {
                    string currentFormFieldsHeader = string.Empty;
                    //sql injection the current input field only
                    if (currentFormFieldsHeader != string.Empty) // second param
                    {
                        currentFormFieldsHeader += "&" + inputFields[currentFormID][currentInputFieldID] + "=" + sqlAttackPattern;
                    }
                    else // first param
                    {
                        currentFormFieldsHeader += inputFields[currentFormID][currentInputFieldID] + "=" + sqlAttackPattern;
                    }
                    //fill other fields with regular values = for ex '11'.
                    for (int i = 1; i < inputFields[currentFormID].Count; i++)
                    {
                        if (i != currentInputFieldID) // not to add the same param twice
                        {
                            //sql injection the current input field only
                            if (currentFormFieldsHeader != string.Empty) // second param
                            {
                                currentFormFieldsHeader += "&" + inputFields[currentFormID][i] + "=11";
                            }
                            else // first param
                            {
                                currentFormFieldsHeader += inputFields[currentFormID][i] + "=11";
                            }
                        }
                    }

                    //just for tests
                    //System.Windows.Forms.MessageBox.Show(currentFormFieldsHeader);
                    string resultHTML = string.Empty;
                    try
                    {
                        WebPostRequest myPost = new WebPostRequest(currentFormURL);
                        myPost.AddParamsToHeader(currentFormFieldsHeader);
                        resultHTML = myPost.GetResponse();
                    }
                    catch (WebException exep)
                    {

                        SharedVariables.myTestingForm.displayOutputActivity(string.Format("Unknown error : {0}\n\r", exep.Message));
                        // it is a vulnerable page !
                        SharedVariables.myTestingForm.displayOutputActivity("the page : " + currentFormURL + " maybe has a SQL Injection vulnerable in \"" + inputFields[currentFormID][currentInputFieldID] + "\" form field\n\r saving the vulnerability for later reviews\n\r");
                        ExploitsManager e = new ExploitsManager();
                        e.add(_profileID.ToString(), "Maybe SQL Injection", currentFormURL + " \n\r form fields values : " + currentFormFieldsHeader, inputFields[currentFormID][currentInputFieldID]);
                    }

                    //check the returned page

                    foreach (string s in sqlSuccessResult)
                    {
                        if (resultHTML.Contains(s))
                        {
                            // it is a vulnerable page !
                            SharedVariables.myTestingForm.displayOutputActivity("the page : " + currentFormURL + " has a SQL Injection vulnerable in \"" + inputFields[currentFormID][currentInputFieldID] + "\" form field\n\r saving the vulnerability for later reviews\n\r");
                            ExploitsManager e = new ExploitsManager();
                            e.add(_profileID.ToString(), "SQL Injection", currentFormURL + " \n\r form fields values : " + currentFormFieldsHeader, inputFields[currentFormID][currentInputFieldID]);
                            continue;
                        }
                    }
                }
            }
        }



        /// <summary>
        /// attack each query string with SQL injection pattern to know exactly where is the exploit.
        /// </summary>
        public void attackEachQueryString(string URL)
        {
            HtmlParser parser = new HtmlParser(URL, string.Empty);
            List<string> queryStrings = parser.getQueryStringParams(URL);
            string nativeURL = URL.Split("?".ToCharArray())[0];  //get the link without query strings
            string targetURL;
            for (int i = 0; i < queryStrings.Count; i++)
            {
                targetURL = nativeURL + "?";
                if (targetURL[targetURL.Length - 1].ToString() == "?")//first param
                {
                    //change just current query string with SQL injection pattern
                    targetURL += queryStrings[i].Split("=".ToCharArray())[0].ToString() + "=" + sqlAttackPattern;
                }
                else
                {
                    //change just current query string with SQL injection pattern
                    targetURL += "&" + queryStrings[i].Split("=".ToCharArray())[0].ToString() + "=" + sqlAttackPattern;
                }
                for (int j = 0; j < queryStrings.Count; j++)
                {
                    if (j != i) // not to add the same param twice
                    {
                        if (targetURL[targetURL.Length - 1].ToString() == "?")//first param
                        {
                            //change just current query string with SQL Injection pattern
                            targetURL += queryStrings[j];
                        }
                        else
                        {
                            //change just current query string with SQL Injection pattern
                            targetURL += "&" + queryStrings[j];
                        }
                    }
                }

                //just for tests
                //System.Windows.Forms.MessageBox.Show(targetURL);

                //attack the query strings
                string resultHTML = string.Empty;
                try
                {
                    HttpWebRequest req = HttpWebRequest.Create(targetURL) as HttpWebRequest;
                    req.Method = "GET";
                    HttpWebResponse res = req.GetResponse() as HttpWebResponse;
                    using (Stream s = res.GetResponseStream())
                    {
                        using (StreamReader sr = new StreamReader(s))
                        {
                            //Read the whole content of the response stream into a string
                            resultHTML = sr.ReadToEnd();
                        }
                    }
                }
                catch (WebException exep)
                {

                    SharedVariables.myTestingForm.displayOutputActivity(string.Format("Unknown error : {0}\n", exep.Message));
                    // it is a vulnerable page !
                    SharedVariables.myTestingForm.displayOutputActivity("the page : " + URL + " maybe has a SQL Injection vulnerable in one of its form query strings\n saving the vulnerability for later reviews\n");
                    ExploitsManager e = new ExploitsManager();
                    e.add(_profileID.ToString(), "Maybe SQL Injection", targetURL, queryStrings[i].Split("=".ToCharArray())[0].ToString());
                }


                //check the results
                foreach (string s in sqlSuccessResult)
                {
                    if (resultHTML.Contains(s))
                    {
                        // it is a vulnerable page !
                        SharedVariables.myTestingForm.displayOutputActivity("the page : " + nativeURL + " has a SQL Injection vulnerable in one of its query string parameters\n saving the vulnerability for later reviews");
                        ExploitsManager e = new ExploitsManager();
                        e.add(_profileID.ToString(), "SQL Injection", targetURL, queryStrings[i].Split("=".ToCharArray())[0].ToString());
                        continue;
                    }
                }
            }
        }

        /// <summary>
        ///  attack all query strings with SQL Injection pattern.
        /// </summary>
        public void attackAllQueryStrings(string URL)
        {
            HtmlParser parser = new HtmlParser(URL, string.Empty);
            List<string> queryStrings = parser.getQueryStringParams(URL);
            string nativeURL = URL.Split("?".ToCharArray())[0];  //get the link without query strings
            string targetURL = nativeURL += "?";
            foreach (string p in queryStrings)
            {
                if (targetURL[targetURL.Length - 1].ToString() == "?")
                {
                    //first param in query string without &
                    targetURL += p.Split("=".ToCharArray())[0] + "=" + sqlAttackPattern;
                }
                else
                {
                    //from second param we must add & before the param!
                    targetURL += "&" + p.Split("=".ToCharArray())[0] + "=" + sqlAttackPattern;
                }
            }

            //just for testing
            //System.Windows.Forms.MessageBox.Show(targetURL);

            //attack the query strings
            WebCrawler attacker = new WebCrawler(targetURL);
            string resultHTML = attacker.fetchPage();
            //check the results
            foreach (string s in sqlSuccessResult)
            {
                if (resultHTML.Contains(s))
                {
                    // it is a vulnerable page !
                    SharedVariables.myTestingForm.displayOutputActivity("the page : " + nativeURL + " has a SQL Injection vulnerable in one of its query string parameters\n saving the vulnerability for later reviews");
                    ExploitsManager e = new ExploitsManager();
                    e.add(_profileID.ToString(), "SQL Injection", targetURL,"Unknown");
                }
            }
        }
                     

    }
}
